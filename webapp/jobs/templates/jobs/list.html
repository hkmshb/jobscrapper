{% extends "base.html" %}

{% block title %} Job - Search {% endblock %}

{% block content %}
  {{ form.non_field_errors }}

  <form>
    <div class="columns">
      <h1 class="title column is-narrow" style="width: 280px">
        Openings Search
      </h1>
      <div class="column is-narrow" style="width: 200px; margin-top: 9px">
        <input
          id="is_spatial"
          type="checkbox"
          name="is_spatial"
          class="switch is-rounded is-info is-small"
          {% if form.is_spatial.value %}
            checked="checked"
          {% endif %}
        >
        <label for="is_spatial">Geospatial</label>
      </div>
      <div class="column is-narrow"></div>
    </div>

    <div class="search">
      <div class="field is-grouped">
        <p class="control">
          <div>
            <input
              class="input {% if form.q.errors %}is-danger{% endif %}"
              type="text"
              name="q"
              placeholder="Find an opening"
              value={{ form.q.value | default_if_none:'' }}
            >
            <span class="is-size-7 is-italic has-text-danger">{{ form.q.errors }}</span>
          </div>

          <div id="locations" class="ml-3 {% if form.is_spatial.value is False %}is-hidden{% endif %}">
            <div class="select {% if form.location.errors %} is-danger {% endif %}">
              {{ form.location }}
            </div>
            <span class="is-size-7 is-italic has-text-danger">{{ form.location.errors }}</span>
          </div>
        </p>
        <p class="control ml-3">
          <button class="button is-info" type="submit">
            Search
          </button>
        </p>
      </div>
    </div>
  </form>

  {% if locations %}
  <div class="mt-3">
    <b>Matched Locations:</b> {% for loc in locations %} {{ loc.name }}; {% endfor %}
  </div>
  {% endif %}

  <div class="openings mt-5">
    <table class="table is-fullwidth is-hoverable is-striped">
      <thead>
        <tr>
          <th>Role Title</th>
          <th>Company</th>
          <th>Remote</th>
          <th>401K</th>
          <th>Dental Ins.</th>
          <th>Health Ins.</th>
          <th></th>
        </tr>
      </thead>
      <tbody>
        {% for opening in openings %}
          <tr>
            <td><a href="{% url 'show' opening.id %}">{{ opening.role_title }}</a></td>
            <td>{{ opening.company.name }}</td>
            <td>{{ opening.is_remote | default_if_none:'-' }}
            <td>{{ opening.has_401k | default_if_none:'-' }}
            <td>{{ opening.has_dentalins | default_if_none:'-' }}
            <td>{{ opening.has_healthins | default_if_none:'-' }}
            <td><a target="_blank" href="{{opening.url }}">visit page</a></td>
          </tr>
        {% empty %}
          <tr>
            <td colspan="3">No openings found</td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  {% if openings.has_other_pages %}
  <nav class="pagination is-small mt-5" role="navigation" aria-label="pagination">
    {% if openings.has_previous %}
      <a class="pagination-previous" href="?page={{ openings.previous_page_number }}&{{ form.urlencode }}">Previous</a>
    {% endif %}

    {% if openings.has_next %}
      <a class="pagination-next" href="?page={{ openings.next_page_number }}&{{ form.urlencode }}">Next page</a>
    {% endif %}

    <ul class="pagination-list">
      {% for page in openings.paginator.page_range %}
        <li>
          <a
            class="pagination-link {% ifequal page openings.number %} is-current {% endifequal %}"
            aria-label="Goto page {{ page }}"
            href="?page={{ page }}&{{ form.urlencode }}"
          >
            {{ page }}
          </a>
        </li>
      {% endfor %}
    </ul>
  </nav>
  {% endif %}

{% endblock %}

{% block scripts %}
  <script type="text/javascript">
    window.addEventListener("load", function() {
      var spatial = $('#is_spatial');
      var locations = $('#locations');

      if (spatial.value[0] && locations.value[0]) {
        spatial.on('click', function() {
          var checked = spatial.value[0].checked;
          if (checked) {
            locations.removeClass("is-hidden");
          } else {
            locations.addClass("is-hidden");
            $('#id_location').value[0].selectedIndex = 0;
          }
        });
      }
    });
  </script>
{% endblock %}
